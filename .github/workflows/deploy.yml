name: Deploy MkDocs to GitHub Pages

on:
  # main ë¸Œëœì¹˜ì— pushë  ë•Œ ìë™ ë°°í¬
  push:
    branches:
      - main
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥ (ë²„ì „ ì…ë ¥ ë°›ìŒ)
  workflow_dispatch:
    inputs:
      version:
        description: 'ë°°í¬í•  ë²„ì „ (ì˜ˆ: v1.0, v1.1)'
        required: true
        default: 'latest'

# GitHub Pagesì— ë°°í¬í•˜ê¸° ìœ„í•œ ê¶Œí•œ
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # mikeê°€ git íˆìŠ¤í† ë¦¬ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract version from release notes
        id: version
        run: |
          # release-notes.mdì—ì„œ ìµœì‹  ë²„ì „ ë²ˆí˜¸ ì¶”ì¶œ (ì˜ˆ: v1.2.0)
          VERSION=$(grep -oP '## v\K[0-9]+\.[0-9]+\.[0-9]+' docs/99-release-notes.md | head -1)
          if [ -z "$VERSION" ]; then
            VERSION="0.0.0"
          fi
          # mikeìš© ë‹¨ì¶• ë²„ì „ (v1.2)
          SHORT_VERSION="v$(echo $VERSION | cut -d. -f1,2)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_version=$SHORT_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ ì¶”ì¶œëœ ë²„ì „: v$VERSION (ë³„ì¹­: $SHORT_VERSION)"

      - name: Clean stale latest version
        run: |
          # ê¸°ì¡´ì— 'latest'ê°€ ë²„ì „ ì´ë¦„ìœ¼ë¡œ ì¡´ì¬í•˜ë©´ ì‚­ì œ (alias ì¶©ëŒ ë°©ì§€)
          if mike list | grep -q "^latest"; then
            echo "ğŸ§¹ ê¸°ì¡´ latest ë²„ì „ ì‚­ì œ"
            mike delete --push latest || true
          fi

      - name: Deploy with mike
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "ğŸ“¦ ìˆ˜ë™ ë°°í¬: ë²„ì „ $INPUT_VERSION"
            mike deploy --push --update-aliases "$INPUT_VERSION" latest
            mike set-default --push latest
          else
            SHORT_VERSION="${{ steps.version.outputs.short_version }}"
            FULL_VERSION="v${{ steps.version.outputs.version }}"
            echo "ğŸ“¦ ìë™ ë°°í¬: $SHORT_VERSION ($FULL_VERSION) + latest"
            mike deploy --push --update-aliases "$SHORT_VERSION" latest --title "$SHORT_VERSION ($FULL_VERSION)"
            mike set-default --push latest
          fi

      - name: Deploy result
        run: |
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ ì‚¬ì´íŠ¸ URL: https://kwag93.github.io/claude-code-onboarding-site/"
